---
import { readFile } from 'fs/promises';
import { join } from 'path';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { parseGlossary } from '../utils/glossaryParser';
import { render } from '../utils/markdownRenderer.js';

// Read the glossary markdown file
// In Astro, we need to resolve paths relative to the project root
const projectRoot = process.cwd();
const glossaryPath = join(projectRoot, 'src/content/pages/NLP Glossary.md');
const glossaryContent = await readFile(glossaryPath, 'utf-8');

// Parse the glossary into terms
const terms = parseGlossary(glossaryContent);

// Render all terms' markdown content (we'll show/hide them client-side)
const renderedTerms = await Promise.all(
	terms.map(async (term) => ({
		...term,
		renderedContent: await render(term.content, terms),
	}))
);

// Default to first term
const defaultTerm = renderedTerms[0];
---

<html lang="en">
	<head>
		<BaseHead 
			title="NLP Glossary - Philip Englund Mathieu" 
			description="A comprehensive glossary of NLP and machine learning terms with definitions, references, and examples." 
		/>
		<style>
			/* Custom scrollbar styling */
			.term-list-container {
				scrollbar-width: thin;
				scrollbar-color: var(--color-gray-300) var(--color-gray-100);
			}
			
			.term-list-container::-webkit-scrollbar {
				width: 8px;
			}
			
			.term-list-container::-webkit-scrollbar-track {
				background: var(--color-gray-100);
				border-radius: 4px;
			}
			
			.term-list-container::-webkit-scrollbar-thumb {
				background: var(--color-gray-300);
				border-radius: 4px;
			}
			
			.term-list-container::-webkit-scrollbar-thumb:hover {
				background: var(--color-gray-500);
			}
			
			.term-link.active {
				background-color: var(--color-primary-500);
				color: white;
				font-weight: 500;
				position: relative;
			}
			
			.term-link.active::before {
				content: "";
				position: absolute;
				left: 0;
				top: 0;
				bottom: 0;
				width: 3px;
				background-color: var(--color-primary-600);
				border-radius: 4px 0 0 4px;
			}
			
			.term-section {
				display: none;
				scroll-margin-top: 80px;
			}
			
			.term-section.active {
				display: block;
			}
			
			/* Style "See also" sections - target paragraphs followed by lists */
			.term-body p + ul {
				list-style: none;
			}
			
			.term-body p + ul li::before {
				content: "â€¢";
				position: absolute;
				left: 0.5rem;
				color: var(--color-link-500);
				font-weight: bold;
			}
			
			/* Style paragraphs with strong text (for "See also:" headings) */
			.term-body p strong {
				display: block;
			}
			
			/* Style paragraphs that contain "See also:" - add spacing and border */
			.term-body p:has(strong) + ul {
				margin-top: 0.5rem;
			}
			
			/* Add border above "See also" sections when they follow content */
			.term-body p:has(strong) {
				margin-top: 2.5rem;
				padding-top: 1.5rem;
				border-top: 1px solid var(--color-gray-200);
				margin-bottom: 0.75rem;
			}
			
			/* Don't add border to first strong paragraph */
			.term-body > p:first-child:has(strong) {
				border-top: none;
				padding-top: 0;
				margin-top: 0;
			}
			
			/* Style internal glossary links (links to other terms) */
			.term-body a[href^="#"] {
				color: var(--color-link-500);
				text-decoration: underline;
				text-decoration-thickness: 1.5px;
				text-underline-offset: 2px;
				transition: color 0.2s ease;
			}
			
			.term-body a[href^="#"]:hover {
				color: var(--color-link-600);
				text-decoration-thickness: 2px;
			}
			
			/* Style external links (URLs and citations) */
			.term-body a[href^="http"],
			.term-body a[href^="https"] {
				color: var(--color-link-500);
				text-decoration: underline;
				text-decoration-style: dashed;
				text-underline-offset: 2px;
			}
			
			.term-body a[href^="http"]:hover,
			.term-body a[href^="https"]:hover {
				text-decoration-style: solid;
			}
			
			/* KaTeX math styling */
			.katex {
				font-size: 1.1em;
			}
			
			.katex-display {
				margin: 1.5rem 0;
				overflow-x: auto;
				overflow-y: hidden;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<div class="glossary-container grid grid-cols-[280px_1fr] gap-8 max-w-[1200px] mx-auto px-4 py-8 items-start max-md:grid-cols-1 max-md:gap-6 max-md:py-8 max-md:px-4">
				<aside class="glossary-sidebar sticky top-20 self-start max-h-[calc(100vh-100px)] flex flex-col pr-4 overflow-hidden max-md:relative max-md:top-0 max-md:max-h-none max-md:overflow-y-visible">
					<div class="term-list-container flex-1 overflow-y-auto overflow-x-hidden">
						<ul class="term-list list-none p-0 m-0 max-md:grid max-md:grid-cols-[repeat(auto-fill,minmax(200px,1fr))] max-md:gap-2">
						{terms.map(term => (
							<li class="term-list-item mb-2">
								<a
									href={`#${term.id}`}
									class="term-link block px-3 py-2 text-gray-600 no-underline rounded transition-colors duration-200 text-sm leading-[1.4] hover:bg-gray-200 hover:text-gray-800 max-md:text-[0.8125rem] max-md:px-2 max-md:py-1.5"
									data-term-id={term.id}
								>
									{term.title}
								</a>
							</li>
						))}
						</ul>
					</div>
				</aside>
				
				<article class="glossary-content max-w-[700px] pt-0">
					{renderedTerms.map((term) => (
						<div
							class="term-section pt-0"
							id={term.id}
							data-term-id={term.id}
							style:display={term.id === defaultTerm.id ? 'block' : 'none'}
						>
							<div class="term-header mt-0 mb-8 pt-0 pb-4 border-b-2 border-primary-600">
								<h1 class="mt-0 mb-2 text-gray-800">{term.title}</h1>
							</div>
							<div class="term-body text-gray-600 leading-[1.6] [&_p]:mb-6 [&_code]:px-1 [&_code]:py-0.5 [&_code]:bg-gray-200 [&_code]:rounded [&_code]:text-[0.875em] [&_pre]:p-5 [&_pre]:bg-gray-200 [&_pre]:rounded-md [&_pre]:overflow-x-auto [&_pre]:my-6 [&_pre_code]:bg-transparent [&_pre_code]:p-0 [&_ul]:my-4 [&_ol]:my-4 [&_ul]:pl-6 [&_ol]:pl-6 [&_li]:my-2 [&_strong]:font-semibold [&_strong]:text-gray-800" set:html={term.renderedContent} />
							
							<div class="introduction-section max-w-[700px] mt-16 pt-8 border-t border-gray-200 max-md:mt-12 max-md:pt-6">
								<div class="introduction-header mb-2">
									<h1 class="m-0 text-xs text-gray-500 font-medium leading-[1.3] uppercase tracking-wider font-sans max-md:text-[0.6875rem]">About this Glossary</h1>
								</div>
								<div class="introduction-content text-gray-500 leading-[1.6] text-[0.8125rem] max-md:text-xs">
									<p class="mb-3 last:mb-0">
										This glossary contains definitions and explanations of key terms related to Natural Language Processing (NLP), 
										machine learning, and large language models. Terms are organized alphabetically and include cross-references, 
										mathematical formulas, and code examples where relevant.
									</p>
									<p class="mb-3 last:mb-0">
										Use the sidebar navigation to browse terms, or click on internal links within definitions to explore related concepts.
									</p>
								</div>
							</div>
						</div>
					))}
				</article>
			</div>
		</main>
		<Footer />
		
		<script>
			// Client-side navigation for glossary terms
			function showTerm(termId) {
				// Hide all term sections
				document.querySelectorAll('.term-section').forEach(section => {
					section.classList.remove('active');
					section.style.display = 'none';
				});
				
				// Show selected term
				const selectedSection = document.querySelector(`.term-section[data-term-id="${termId}"]`);
				if (selectedSection) {
					selectedSection.classList.add('active');
					selectedSection.style.display = 'block';
				}
				
				// Update active link
				document.querySelectorAll('.term-link').forEach(link => {
					link.classList.remove('active');
					if (link.getAttribute('data-term-id') === termId) {
						link.classList.add('active');
					}
				});
				
				// Update URL hash
				window.location.hash = termId;
				
				// Scroll to top of content, accounting for sticky header
				// The scroll-margin-top CSS will handle the offset
				if (selectedSection) {
					setTimeout(() => {
						selectedSection.scrollIntoView({ 
							behavior: 'smooth', 
							block: 'start' 
						});
					}, 10);
				}
			}
			
			document.addEventListener('DOMContentLoaded', () => {
				// Get initial term from hash or use default
				const hash = window.location.hash.slice(1);
				const initialTermId = hash || document.querySelector('.term-section')?.getAttribute('data-term-id') || '';
				if (initialTermId) {
					showTerm(initialTermId);
				}
				
				// Handle sidebar link clicks
				document.querySelectorAll('.term-link').forEach(link => {
					link.addEventListener('click', (e) => {
						e.preventDefault();
						const termId = link.getAttribute('data-term-id');
						if (termId) {
							showTerm(termId);
						}
					});
				});
				
				// Handle hash changes (browser back/forward or direct URL access)
				window.addEventListener('hashchange', () => {
					const hash = window.location.hash.slice(1);
					if (hash) {
						showTerm(hash);
					}
				});
			});
		</script>
	</body>
</html>

